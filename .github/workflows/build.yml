name: Build Windows EXE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1ï¸âƒ£ Puxar o cÃ³digo do repositÃ³rio
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Python
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3ï¸âƒ£ Instalar dependÃªncias e Playwright
      - name: Instalar dependÃªncias
        run: |
          echo "ğŸ”¹ Atualizando pip e instalando requirements..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "ğŸ”¹ Instalando browsers do Playwright..."
          playwright install --with-deps

      # 4ï¸âƒ£ Copiar Chromium do Playwright de forma segura
      - name: Preparar Chromium para PyInstaller
        shell: pwsh
        run: |
          echo "ğŸ”¹ Descobrindo caminho do Chromium instalado pelo Playwright..."
          $chromiumPath = python -c "from playwright.sync_api import sync_playwright; p=sync_playwright().start(); print(p.chromium.executable_path)"
          echo "ğŸ”¹ Caminho do Chromium encontrado: $chromiumPath"

          echo "ğŸ”¹ Criando pasta destino no projeto..."
          $dest = "automacoes\playwright_browsers\chrome-win32"
          mkdir $dest -Force

          echo "ğŸ”¹ Copiando Chromium para o projeto..."
          Copy-Item $chromiumPath $dest -Force
          echo "âœ… Chromium preparado com sucesso."

      # 5ï¸âƒ£ Gerar EXE com PyInstaller
      - name: Gerar EXE
        run: |
          echo "ğŸ”¹ Rodando PyInstaller..."
          pyinstaller --onefile --log-level=DEBUG automacoes/main.py
          echo "âœ… Build do EXE concluÃ­do."

      # 6ï¸âƒ£ Upload do EXE gerado como artefato
      - name: Upload artefato
        uses: actions/upload-artifact@v4
        with:
          name: automacao-windows
          path: dist/*.exe
          retention-days: 7